<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Computer Maintenance Scheduler</title>
<style>
body{font-family:Arial;background:#f4f4f9;display:flex;justify-content:center;padding:20px;}
.container{background:white;padding:25px;border-radius:12px;box-shadow:0 4px 8px rgba(0,0,0,0.1);width:100%;max-width:420px;}
h2{text-align:center;}
label{margin-top:10px;display:block;font-weight:bold;}
input,select,textarea,button{width:100%;padding:10px;margin-top:5px;border-radius:6px;border:1px solid #ccc;font-size:15px;}
button{background:#4CAF50;color:white;border:none;cursor:pointer;margin-top:15px;}
.cancel{background:#f44336;}
.deleteBtn{background:#333;margin-top:8px;color:white;border:none;padding:8px;border-radius:4px;cursor:pointer;}
.task-list{margin-top:20px;}
.task-item{background:#e9e9ff;padding:12px;margin-bottom:10px;border-radius:8px;font-size:14px;border-left:4px solid #4CAF50;}
.empty-state{color:#666;text-align:center;padding:20px;font-style:italic;}
.status-box{font-size:12px;padding:8px;border-radius:4px;margin-bottom:10px;text-align:center;}
.status-enabled{background:#d4edda;color:#155724;}
.status-disabled{background:#f8d7da;color:#721c24;}
.enable-notif-btn{background:#007bff;margin-bottom:10px;}
</style>
</head>
<body>
<div class="container">
<h2>Schedule Maintenance</h2>

<div id="notifStatus" class="status-box status-disabled">
üîï Notifications Disabled - Click below to enable
</div>

<button id="enableNotifBtn" class="enable-notif-btn" onclick="enableNotifications()">
üîî Enable Background Notifications
</button>

<form id="maintenanceForm">
<label>Computer Unit</label>
<select id="computer" required>
<option value="">Select Computer</option>
<option>PC-01</option>
<option>PC-02</option>
<option>PC-03</option>
<option>PC-04</option>
<option>PC-05</option>
</select>

<label>Date</label>
<input type="date" id="date" required>

<label>Time</label>
<input type="time" id="time" required>

<label>Maintenance Type</label>
<select id="type" required>
<option value="">Select Type</option>
<option>Cleaning</option>
<option>Software Update</option>
<option>Hardware Check</option>
<option>Troubleshooting</option>
</select>

<label>Technician</label>
<input type="text" id="technician" required>

<label>Notes</label>
<textarea id="notes"></textarea>

<button type="submit">Save Task</button>
<button type="button" class="cancel" onclick="resetForm()">Cancel</button>
</form>

<div class="task-list" id="taskList">
<h3>Upcoming Tasks (<span id="taskCount">0</span>)</h3>
</div>
</div>

<script>
// Register Service Worker immediately
let swRegistration = null;

if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js')
        .then(reg => {
            console.log('Service Worker registered:', reg);
            swRegistration = reg;
            updateNotifStatus();
        })
        .catch(err => console.error('SW registration failed:', err));
}

// Check notification status
function updateNotifStatus() {
    const statusDiv = document.getElementById('notifStatus');
    const btn = document.getElementById('enableNotifBtn');
    
    if (Notification.permission === 'granted') {
        statusDiv.textContent = 'üîî Notifications Enabled - Works even when Chrome is minimized!';
        statusDiv.className = 'status-box status-enabled';
        btn.style.display = 'none';
    } else if (Notification.permission === 'denied') {
        statusDiv.textContent = '‚ùå Notifications Blocked - Check browser settings';
        statusDiv.className = 'status-box status-disabled';
        btn.style.display = 'none';
    }
}

// Enable notifications (MUST be triggered by user gesture)
async function enableNotifications() {
    if (!('Notification' in window)) {
        alert('This browser does not support notifications');
        return;
    }
    
    const permission = await Notification.requestPermission();
    updateNotifStatus();
    
    if (permission === 'granted') {
        // Send test notification
        if (swRegistration) {
            swRegistration.showNotification('‚úÖ Notifications Enabled!', {
                body: 'You will now receive maintenance alerts even when Chrome is minimized.',
                icon: 'https://cdn-icons-png.flaticon.com/512/3063/3063822.png',
                badge: 'https://cdn-icons-png.flaticon.com/512/3063/3063822.png'
            });
        }
        
        // Sync schedules with service worker
        syncWithServiceWorker();
    }
}

// Sync data to Service Worker
function syncWithServiceWorker() {
    if (navigator.serviceWorker.controller) {
        navigator.serviceWorker.controller.postMessage({
            type: 'SYNC_SCHEDULES',
            schedules: schedules
        });
    }
}

const form = document.getElementById("maintenanceForm");
const taskList = document.getElementById("taskList");
const taskCount = document.getElementById("taskCount");

let schedules = JSON.parse(localStorage.getItem("schedules")) || [];

// LOAD SAVED TASKS
displayTasks();

// SAVE TASK
form.addEventListener("submit", function(e){
    e.preventDefault();

    let computer = document.getElementById("computer").value;
    let date = document.getElementById("date").value;
    let time = document.getElementById("time").value;
    let type = document.getElementById("type").value;
    let technician = document.getElementById("technician").value;
    let notes = document.getElementById("notes").value;

    // Conflict Check
    for(let s of schedules){
        if(s.computer === computer && s.date === date && s.time === time){
            alert("Schedule Conflict!");
            return;
        }
    }

    let newTask = {
        id: Date.now(),
        computer,
        date,
        time,
        type,
        technician,
        notes,
        notified: false
    };

    schedules.push(newTask);
    saveAndRefresh();
    form.reset();
    
    // Sync with Service Worker for background monitoring
    syncWithServiceWorker();
});

function saveAndRefresh(){
    localStorage.setItem("schedules", JSON.stringify(schedules));
    displayTasks();
}

// DISPLAY TASKS
function displayTasks(){
    const header = "<h3>Upcoming Tasks (" + schedules.length + ")</h3>";
    
    if(schedules.length === 0){
        taskList.innerHTML = header + '<div class="empty-state">No tasks scheduled. Add one above!</div>';
        taskCount.textContent = "0";
        return;
    }
    
    taskList.innerHTML = header;
    schedules.sort((a,b) => new Date(a.date + "T" + a.time) - new Date(b.date + "T" + b.time));
    
    schedules.forEach((task, index) => {
        let div = document.createElement("div");
        div.className = "task-item";
        let isPast = new Date(task.date + "T" + task.time) < new Date();
        let statusBadge = isPast ? '<span style="color:red">[OVERDUE]</span>' : '';
        
        div.innerHTML = `
            <strong>${task.computer}</strong> ${statusBadge}<br>
            <strong>Type:</strong> ${task.type}<br>
            <strong>When:</strong> ${task.date} at ${task.time}<br>
            <strong>Technician:</strong> ${task.technician}<br>
            ${task.notes ? `<strong>Notes:</strong> ${task.notes}<br>` : ''}
            <button class="deleteBtn" onclick="deleteTask(${index})">Delete</button>
        `;
        taskList.appendChild(div);
    });
    
    taskCount.textContent = schedules.length;
}

// DELETE TASK
function deleteTask(index){
    if(confirm("Delete this task?")){
        schedules.splice(index, 1);
        saveAndRefresh();
        syncWithServiceWorker();
    }
}

// RESET FORM
function resetForm(){
    form.reset();
}

// Listen for messages from Service Worker
navigator.serviceWorker.addEventListener('message', event => {
    if (event.data && event.data.type === 'TASK_DUE') {
        // Refresh display to show notification status
        const task = schedules.find(t => t.id === event.data.taskId);
        if (task) {
            task.notified = true;
            saveAndRefresh();
        }
    }
});

// Periodic sync with Service Worker (every 10 seconds)
setInterval(syncWithServiceWorker, 10000);

// Initial sync
setTimeout(syncWithServiceWorker, 1000);
</script>
</body>
</html>
