html_content = '''<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PC Maintenance Scheduler</title>
<link rel="manifest" href="/manifest.json">
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }

:root {
    --ict-bg: #0d1117;
    --ict-dark: #161b22;
    --ict-border: #30363d;
    --ict-accent: #58a6ff;
    --ict-success: #238636;
    --ict-warning: #f85149;
    --ict-text: #c9d1d9;
    --ict-muted: #8b949e;
    --ict-cyan: #39d0d8;
    --ict-purple: #a371f7;
}

body {
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    background: linear-gradient(135deg, #0d1117 0%, #161b22 50%, #0d1117 100%);
    min-height: 100vh;
    padding: 20px;
    color: var(--ict-text);
}

/* Auth Screens */
.auth-container {
    max-width: 400px;
    margin: 50px auto;
    background: var(--ict-dark);
    border-radius: 16px;
    border: 1px solid var(--ict-border);
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(0,0,0,0.8);
}

.auth-header {
    background: linear-gradient(135deg, var(--ict-dark), var(--ict-bg));
    padding: 40px 30px;
    text-align: center;
    border-bottom: 1px solid var(--ict-border);
}

.auth-logo {
    font-size: 48px;
    margin-bottom: 15px;
}

.auth-title {
    font-size: 22px;
    font-weight: 700;
    color: var(--ict-accent);
    text-transform: uppercase;
    letter-spacing: 2px;
}

.auth-subtitle {
    color: var(--ict-muted);
    margin-top: 10px;
    font-size: 14px;
}

.auth-body {
    padding: 30px;
}

.auth-form {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.auth-input {
    width: 100%;
    padding: 14px;
    background: var(--ict-bg);
    border: 1px solid var(--ict-border);
    border-radius: 8px;
    font-size: 16px;
    color: var(--ict-text);
    transition: all 0.3s;
}

.auth-input:focus {
    outline: none;
    border-color: var(--ict-accent);
    box-shadow: 0 0 0 3px rgba(88,166,255,0.1);
}

.auth-btn {
    width: 100%;
    padding: 16px;
    background: linear-gradient(135deg, var(--ict-success), #2ea043);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 1px;
    transition: all 0.3s;
}

.auth-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(35,134,54,0.4);
}

.auth-link {
    text-align: center;
    color: var(--ict-muted);
    font-size: 14px;
}

.auth-link a {
    color: var(--ict-accent);
    text-decoration: none;
    cursor: pointer;
}

.auth-link a:hover {
    text-decoration: underline;
}

/* Main App Container */
.app-container {
    display: none;
    max-width: 800px;
    margin: 0 auto;
    background: var(--ict-dark);
    border-radius: 16px;
    border: 1px solid var(--ict-border);
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(0,0,0,0.8);
}

/* Header */
.pc-header {
    background: var(--ict-bg);
    padding: 20px 25px;
    border-bottom: 1px solid var(--ict-border);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.pc-title {
    font-size: 18px;
    font-weight: 600;
    color: var(--ict-accent);
    display: flex;
    align-items: center;
    gap: 10px;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.pc-title::before {
    content: '‚óâ';
    color: var(--ict-success);
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.user-info {
    display: flex;
    align-items: center;
    gap: 15px;
    font-size: 14px;
}

.user-badge {
    background: var(--ict-bg);
    padding: 6px 12px;
    border-radius: 20px;
    border: 1px solid var(--ict-border);
    color: var(--ict-cyan);
}

.logout-btn {
    background: transparent;
    border: 1px solid var(--ict-warning);
    color: var(--ict-warning);
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.3s;
}

.logout-btn:hover {
    background: var(--ict-warning);
    color: white;
}

/* Status Bar */
.status-bar {
    display: flex;
    gap: 15px;
    padding: 15px 25px;
    background: var(--ict-bg);
    border-bottom: 1px solid var(--ict-border);
}

.status-pill {
    flex: 1;
    padding: 10px;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 600;
    text-align: center;
    text-transform: uppercase;
    letter-spacing: 1px;
    border: 1px solid;
    background: var(--ict-dark);
}

.status-active {
    border-color: var(--ict-success);
    color: var(--ict-success);
}

.status-inactive {
    border-color: var(--ict-warning);
    color: var(--ict-warning);
}

.status-pending {
    border-color: var(--ict-accent);
    color: var(--ict-accent);
}

/* Main Content */
.pc-content {
    padding: 25px;
}

/* Enable Button */
.enable-btn {
    width: 100%;
    padding: 14px;
    background: linear-gradient(135deg, var(--ict-purple), #8957e5);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 15px;
    font-weight: 700;
    cursor: pointer;
    margin-bottom: 25px;
    text-transform: uppercase;
    letter-spacing: 1px;
    transition: all 0.3s;
    display: none;
}

.enable-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(163,113,247,0.4);
}

.enable-btn.visible {
    display: block;
}

/* Form Styling */
.form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.form-group.full-width {
    grid-column: 1 / -1;
}

label {
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--ict-muted);
    font-weight: 600;
}

input, select, textarea {
    width: 100%;
    padding: 12px 15px;
    background: var(--ict-bg);
    border: 1px solid var(--ict-border);
    border-radius: 8px;
    font-size: 15px;
    color: var(--ict-text);
    transition: all 0.3s;
}

input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: var(--ict-accent);
    box-shadow: 0 0 0 3px rgba(88,166,255,0.1);
}

select {
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2358a6ff' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 15px center;
    padding-right: 40px;
}

/* Buttons */
.btn-group {
    display: flex;
    gap: 15px;
    margin-top: 25px;
}

.btn-primary {
    flex: 2;
    padding: 14px;
    background: linear-gradient(135deg, var(--ict-success), #2ea043);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 15px;
    font-weight: 700;
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 1px;
    transition: all 0.3s;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(35,134,54,0.4);
}

.btn-secondary {
    flex: 1;
    padding: 14px;
    background: transparent;
    color: var(--ict-warning);
    border: 1px solid var(--ict-warning);
    border-radius: 8px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
}

.btn-secondary:hover {
    background: var(--ict-warning);
    color: white;
}

/* Task Section */
.task-section {
    border-top: 1px solid var(--ict-border);
    padding-top: 25px;
    margin-top: 25px;
}

.task-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.task-header h3 {
    font-size: 16px;
    text-transform: uppercase;
    letter-spacing: 2px;
    color: var(--ict-accent);
}

.task-count {
    background: var(--ict-bg);
    color: var(--ict-accent);
    padding: 6px 15px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 700;
    border: 1px solid var(--ict-border);
}

.task-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.task-item {
    background: var(--ict-bg);
    padding: 20px;
    border-radius: 12px;
    border-left: 4px solid var(--ict-accent);
    position: relative;
    transition: all 0.3s;
    border: 1px solid var(--ict-border);
}

.task-item:hover {
    transform: translateX(5px);
    border-color: var(--ict-accent);
}

.task-item.overdue {
    border-left-color: var(--ict-warning);
    border-color: var(--ict-warning);
    background: rgba(248,81,73,0.1);
}

.task-item.soon {
    border-left-color: #f0883e;
    border-color: #f0883e;
    animation: blink 2s infinite;
}

@keyframes blink {
    0%, 100% { box-shadow: 0 0 5px rgba(240,136,62,0.2); }
    50% { box-shadow: 0 0 20px rgba(240,136,62,0.4); }
}

.task-computer {
    font-weight: 700;
    font-size: 16px;
    color: var(--ict-text);
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.task-computer::before {
    content: 'üíª';
}

.task-meta {
    font-size: 14px;
    color: var(--ict-muted);
    line-height: 1.6;
}

.task-meta strong {
    color: var(--ict-accent);
}

.time-remaining {
    position: absolute;
    top: 15px;
    right: 15px;
    background: var(--ict-dark);
    color: var(--ict-accent);
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 700;
    font-family: 'Courier New', monospace;
    border: 1px solid var(--ict-border);
}

.task-actions {
    margin-top: 15px;
    display: flex;
    gap: 10px;
}

.btn-small {
    padding: 8px 16px;
    border: none;
    border-radius: 6px;
    font-size: 12px;
    cursor: pointer;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    transition: all 0.3s;
}

.btn-delete {
    background: transparent;
    color: var(--ict-warning);
    border: 1px solid var(--ict-warning);
}

.btn-delete:hover {
    background: var(--ict-warning);
    color: white;
}

.empty-state {
    text-align: center;
    padding: 50px 20px;
    color: var(--ict-muted);
    border: 2px dashed var(--ict-border);
    border-radius: 12px;
}

.empty-state-icon {
    font-size: 48px;
    margin-bottom: 15px;
    opacity: 0.5;
}

/* Audio Toggle */
.audio-toggle {
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--ict-dark);
    border: 1px solid var(--ict-border);
    width: 45px;
    height: 45px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 20px;
    z-index: 100;
    color: var(--ict-accent);
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
}

.audio-toggle.muted {
    opacity: 0.5;
    color: var(--ict-muted);
}

/* Notification Modal */
.notification-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.9);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    padding: 20px;
    backdrop-filter: blur(10px);
}

.notification-modal {
    background: var(--ict-dark);
    padding: 40px;
    border-radius: 20px;
    text-align: center;
    max-width: 400px;
    width: 100%;
    border: 1px solid var(--ict-accent);
    box-shadow: 0 0 60px rgba(88,166,255,0.2);
    animation: modalPop 0.3s ease;
}

@keyframes modalPop {
    0% { transform: scale(0.8); opacity: 0; }
    100% { transform: scale(1); opacity: 1; }
}

.notification-icon {
    font-size: 60px;
    margin-bottom: 20px;
    animation: bellRing 0.5s ease infinite;
}

@keyframes bellRing {
    0%, 100% { transform: rotate(0deg); }
    25% { transform: rotate(-10deg); }
    75% { transform: rotate(10deg); }
}

.notification-title {
    font-size: 22px;
    font-weight: 700;
    color: var(--ict-accent);
    margin-bottom: 15px;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.notification-text {
    color: var(--ict-muted);
    margin-bottom: 25px;
    line-height: 1.6;
    font-size: 15px;
}

.btn-dismiss {
    background: linear-gradient(135deg, var(--ict-accent), #1f6feb);
    color: white;
    border: none;
    padding: 14px 40px;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    width: 100%;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.hidden {
    display: none !important;
}

/* Responsive */
@media (max-width: 600px) {
    .form-grid {
        grid-template-columns: 1fr;
    }
    
    .pc-header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
    }
    
    .status-bar {
        flex-direction: column;
    }
}
</style>
</head>
<body>

<button class="audio-toggle" id="audioToggle" onclick="toggleAudio()" title="Toggle sound">üîä</button>

<div class="notification-overlay" id="notificationOverlay" onclick="dismissNotification()">
    <div class="notification-modal" onclick="event.stopPropagation()">
        <div class="notification-icon">üîî</div>
        <div class="notification-title" id="notifTitle">Maintenance Due!</div>
        <div class="notification-text" id="notifText">Task details here</div>
        <button class="btn-dismiss" onclick="dismissNotification()">Dismiss</button>
    </div>
</div>

<!-- Login Screen -->
<div id="loginScreen" class="auth-container">
    <div class="auth-header">
        <div class="auth-logo">üîß</div>
        <div class="auth-title">PC Maintenance</div>
        <div class="auth-subtitle">Login to access scheduler</div>
    </div>
    <div class="auth-body">
        <form class="auth-form" id="loginForm">
            <input type="text" class="auth-input" id="loginUsername" placeholder="Username" required>
            <input type="password" class="auth-input" id="loginPassword" placeholder="Password" required>
            <button type="submit" class="auth-btn">Login</button>
        </form>
        <div class="auth-link">
            Don't have an account? <a onclick="showRegister()">Register</a>
        </div>
    </div>
</div>

<!-- Register Screen -->
<div id="registerScreen" class="auth-container hidden">
    <div class="auth-header">
        <div class="auth-logo">üìù</div>
        <div class="auth-title">Create Account</div>
        <div class="auth-subtitle">Register new user</div>
    </div>
    <div class="auth-body">
        <form class="auth-form" id="registerForm">
            <input type="text" class="auth-input" id="regUsername" placeholder="Username" required>
            <input type="password" class="auth-input" id="regPassword" placeholder="Password" required>
            <input type="password" class="auth-input" id="regConfirmPassword" placeholder="Confirm Password" required>
            <button type="submit" class="auth-btn">Register</button>
        </form>
        <div class="auth-link">
            Already have an account? <a onclick="showLogin()">Login</a>
        </div>
    </div>
</div>

<!-- Main App -->
<div id="mainApp" class="app-container">
    <div class="pc-header">
        <div class="pc-title">PC Maintenance Scheduler</div>
        <div class="user-info">
            <span class="user-badge" id="currentUser">User</span>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="status-bar" id="statusBar">
        <div class="status-pill status-inactive" id="notifStatus">üîï Off</div>
        <div class="status-pill status-pending" id="timerStatus">‚è±Ô∏è Waiting</div>
    </div>

    <div class="pc-content">
        <button id="enableNotifBtn" class="enable-btn" onclick="enableNotifications()">
            üîî Enable Notifications
        </button>

        <form id="maintenanceForm">
            <div class="form-grid">
                <div class="form-group">
                    <label>Computer Unit</label>
                    <select id="computer" required>
                        <option value="">Select Computer</option>
                        <option>PC-01</option>
                        <option>PC-02</option>
                        <option>PC-03</option>
                        <option>PC-04</option>
                        <option>PC-05</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Maintenance Type</label>
                    <select id="type" required>
                        <option value="">Select Type</option>
                        <option>Cleaning</option>
                        <option>Software Update</option>
                        <option>Hardware Check</option>
                        <option>Troubleshooting</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="date" required>
                </div>

                <div class="form-group">
                    <label>Time</label>
                    <input type="time" id="time" required step="1">
                </div>

                <div class="form-group full-width">
                    <label>Notes (Optional)</label>
                    <textarea id="notes" rows="3" placeholder="Additional details..."></textarea>
                </div>
            </div>

            <div class="btn-group">
                <button type="submit" class="btn-primary">üíæ Save Task</button>
                <button type="button" class="btn-secondary" onclick="resetForm()">‚ùå Cancel</button>
            </div>
        </form>

        <div class="task-section">
            <div class="task-header">
                <h3>üìã Upcoming Tasks</h3>
                <span class="task-count" id="taskCount">0</span>
            </div>
            <div class="task-list" id="taskList">
                <div class="empty-state">
                    <div class="empty-state-icon">üì≠</div>
                    <div>No tasks scheduled</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Global State
let currentUser = null;
let audioContext = null;
let audioEnabled = true;
let nextTaskTimeout = null;
let checkInterval = null;
let swRegistration = null;

// Initialize
initAudio();

// Check if user is already logged in
checkAuth();

function checkAuth() {
    const savedUser = localStorage.getItem('currentUser');
    if (savedUser) {
        currentUser = JSON.parse(savedUser);
        showMainApp();
    } else {
        showLogin();
    }
}

function showLogin() {
    document.getElementById('loginScreen').classList.remove('hidden');
    document.getElementById('registerScreen').classList.add('hidden');
    document.getElementById('mainApp').style.display = 'none';
}

function showRegister() {
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('registerScreen').classList.remove('hidden');
    document.getElementById('mainApp').style.display = 'none';
}

function showMainApp() {
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('registerScreen').classList.add('hidden');
    document.getElementById('mainApp').style.display = 'block';
    document.getElementById('currentUser').textContent = currentUser.username;
    
    // Initialize app
    document.getElementById('date').min = new Date().toISOString().split('T')[0];
    renderTasks();
    updateStatus();
    scheduleNextCheck();
}

function logout() {
    currentUser = null;
    localStorage.removeItem('currentUser');
    if (nextTaskTimeout) clearTimeout(nextTaskTimeout);
    if (checkInterval) clearInterval(checkInterval);
    showLogin();
}

// Auth Forms
document.getElementById('loginForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const username = document.getElementById('loginUsername').value;
    const password = document.getElementById('loginPassword').value;
    
    const users = JSON.parse(localStorage.getItem('users') || '[]');
    const user = users.find(u => u.username === username && u.password === password);
    
    if (user) {
        currentUser = user;
        localStorage.setItem('currentUser', JSON.stringify(user));
        showMainApp();
        this.reset();
    } else {
        alert('Invalid username or password!');
    }
});

document.getElementById('registerForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const username = document.getElementById('regUsername').value;
    const password = document.getElementById('regPassword').value;
    const confirmPassword = document.getElementById('regConfirmPassword').value;
    
    if (password !== confirmPassword) {
        alert('Passwords do not match!');
        return;
    }
    
    let users = JSON.parse(localStorage.getItem('users') || '[]');
    
    if (users.find(u => u.username === username)) {
        alert('Username already exists!');
        return;
    }
    
    const newUser = {
        id: Date.now(),
        username,
        password,
        created: new Date().toISOString()
    };
    
    users.push(newUser);
    localStorage.setItem('users', JSON.stringify(users));
    
    alert('Registration successful! Please login.');
    showLogin();
    this.reset();
});

// Audio Functions
function initAudio() {
    if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
    }
}

function playAlertSound() {
    if (!audioEnabled || !audioContext) return;
    
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    oscillator.frequency.setValueAtTime(880, audioContext.currentTime);
    oscillator.frequency.setValueAtTime(440, audioContext.currentTime + 0.1);
    oscillator.frequency.setValueAtTime(880, audioContext.currentTime + 0.2);
    
    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
    
    oscillator.start(audioContext.currentTime);
    oscillator.stop(audioContext.currentTime + 0.5);
    
    setTimeout(() => {
        const osc2 = audioContext.createOscillator();
        const gain2 = audioContext.createGain();
        osc2.connect(gain2);
        gain2.connect(audioContext.destination);
        osc2.frequency.setValueAtTime(880, audioContext.currentTime);
        gain2.gain.setValueAtTime(0.3, audioContext.currentTime);
        gain2.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
        osc2.start(audioContext.currentTime);
        osc2.stop(audioContext.currentTime + 0.5);
    }, 200);
}

function toggleAudio() {
    audioEnabled = !audioEnabled;
    const btn = document.getElementById('audioToggle');
    btn.textContent = audioEnabled ? 'üîä' : 'üîá';
    btn.classList.toggle('muted', !audioEnabled);
    initAudio();
}

// Service Worker
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js')
        .then(reg => {
            swRegistration = reg;
            updateStatus();
        })
        .catch(err => {
            console.error('SW registration failed:', err);
        });
}

function updateStatus() {
    const notifStatus = document.getElementById('notifStatus');
    const timerStatus = document.getElementById('timerStatus');
    const btn = document.getElementById('enableNotifBtn');
    
    if (!('Notification' in window)) {
        notifStatus.textContent = 'üîï Not Supported';
        notifStatus.className = 'status-pill status-inactive';
        btn.classList.remove('visible');
        return;
    }
    
    if (Notification.permission === 'granted') {
        notifStatus.textContent = 'üîî Active';
        notifStatus.className = 'status-pill status-active';
        timerStatus.textContent = '‚è±Ô∏è Monitoring';
        timerStatus.className = 'status-pill status-active';
        btn.classList.remove('visible');
        scheduleNextCheck();
    } else if (Notification.permission === 'denied') {
        notifStatus.textContent = '‚ùå Blocked';
        notifStatus.className = 'status-pill status-inactive';
        btn.classList.remove('visible');
    } else {
        notifStatus.textContent = 'üîï Off';
        notifStatus.className = 'status-pill status-inactive';
        timerStatus.textContent = '‚è±Ô∏è Waiting';
        btn.classList.add('visible');
    }
}

async function enableNotifications() {
    initAudio();
    if (!('Notification' in window)) return;
    
    try {
        const permission = await Notification.requestPermission();
        updateStatus();
        
        if (permission === 'granted') {
            new Notification('‚úÖ Notifications Active', {
                body: 'You will receive maintenance alerts with sound',
                icon: 'https://cdn-icons-png.flaticon.com/512/3063/3063822.png'
            });
        }
    } catch (err) {
        console.error(err);
    }
}

// Data Management - Per User
function getSchedules() {
    if (!currentUser) return [];
    const key = `schedules_${currentUser.id}`;
    return JSON.parse(localStorage.getItem(key)) || [];
}

function saveSchedules(schedules) {
    if (!currentUser) return;
    const key = `schedules_${currentUser.id}`;
    localStorage.setItem(key, JSON.stringify(schedules));
}

// Form Handling
document.getElementById("maintenanceForm").addEventListener("submit", function(e) {
    e.preventDefault();
    initAudio();
    
    const computer = document.getElementById("computer").value;
    const date = document.getElementById("date").value;
    const time = document.getElementById("time").value;
    const type = document.getElementById("type").value;
    const notes = document.getElementById("notes").value;
    
    let schedules = getSchedules();
    
    // Conflict Check
    const conflict = schedules.find(s => s.computer === computer && s.date === date && s.time === time && !s.completed);
    if (conflict) {
        alert("‚ö†Ô∏è Schedule Conflict!\\n\\nThis computer already has maintenance at this time.");
        return;
    }
    
    const newTask = {
        id: Date.now(),
        computer,
        date,
        time,
        type,
        notes,
        created: new Date().toISOString(),
        completed: false,
        notified: false,
        userId: currentUser.id
    };
    
    schedules.push(newTask);
    saveSchedules(schedules);
    saveAndRefresh();
    resetForm();
    
    if (Notification.permission === 'default') {
        enableNotifications();
    }
    
    const btn = e.target.querySelector('.btn-primary');
    const originalText = btn.textContent;
    btn.textContent = '‚úÖ Saved!';
    setTimeout(() => btn.textContent = originalText, 1500);
});

function saveAndRefresh() {
    renderTasks();
    syncWithServiceWorker();
    scheduleNextCheck();
}

function resetForm() {
    document.getElementById("maintenanceForm").reset();
    document.getElementById('date').min = new Date().toISOString().split('T')[0];
}

function renderTasks() {
    const container = document.getElementById("taskList");
    const countBadge = document.getElementById("taskCount");
    const schedules = getSchedules();
    
    countBadge.textContent = schedules.length;
    
    if (schedules.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üì≠</div>
                <div>No tasks scheduled</div>
            </div>`;
        return;
    }
    
    const sorted = [...schedules].sort((a, b) => {
        if (a.completed !== b.completed) return a.completed ? 1 : -1;
        return new Date(a.date + 'T' + a.time) - new Date(b.date + 'T' + b.time);
    });
    
    const now = new Date();
    
    container.innerHTML = sorted.map(task => {
        const taskDateTime = new Date(task.date + 'T' + task.time);
        const diff = taskDateTime - now;
        const isOverdue = diff < 0;
        const isSoon = !task.completed && diff > 0 && diff < 3600000;
        
        let statusClass = '';
        if (task.completed) statusClass = '';
        else if (isOverdue) statusClass = 'overdue';
        else if (isSoon) statusClass = 'soon';
        
        const timeRemaining = task.completed ? '' : getTimeRemaining(taskDateTime, now);
        
        return `
            <div class="task-item ${statusClass}">
                ${timeRemaining ? `<div class="time-remaining">${timeRemaining}</div>` : ''}
                <div class="task-computer">${task.computer} ${task.notified ? '‚úì' : ''}</div>
                <div class="task-meta">
                    <strong>${task.type}</strong><br>
                    üìÖ ${task.date} at ${task.time}
                    ${task.notes ? '<br>üìù ' + task.notes : ''}
                </div>
                <div class="task-actions">
                    <button class="btn-small btn-delete" onclick="deleteTask(${task.id})">üóëÔ∏è Delete</button>
                </div>
            </div>
        `;
    }).join('');
}

function getTimeRemaining(target, now) {
    const diff = target - now;
    if (diff < 0) return 'OVERDUE';
    if (diff < 60000) return '< 1m';
    if (diff < 3600000) return Math.floor(diff / 60000) + 'm';
    if (diff < 86400000) return Math.floor(diff / 3600000) + 'h';
    return Math.floor(diff / 86400000) + 'd';
}

function deleteTask(id) {
    if (!confirm('Delete this task?')) return;
    let schedules = getSchedules();
    schedules = schedules.filter(s => s.id !== id);
    saveSchedules(schedules);
    saveAndRefresh();
}

// Timing Engine
function scheduleNextCheck() {
    if (nextTaskTimeout) clearTimeout(nextTaskTimeout);
    if (checkInterval) clearInterval(checkInterval);
    
    const schedules = getSchedules();
    const now = new Date();
    const pendingTasks = schedules.filter(s => !s.completed && !s.notified);
    
    if (pendingTasks.length === 0) {
        document.getElementById('timerStatus').textContent = '‚è±Ô∏è No tasks';
        return;
    }
    
    const nextTask = pendingTasks
        .map(t => ({...t, dateTime: new Date(t.date + 'T' + t.time)}))
        .filter(t => t.dateTime > now)
        .sort((a, b) => a.dateTime - b.dateTime)[0];
    
    if (!nextTask) {
        document.getElementById('timerStatus').textContent = '‚è±Ô∏è All passed';
        return;
    }
    
    const msUntil = nextTask.dateTime - now;
    const minutesUntil = Math.floor(msUntil / 60000);
    
    document.getElementById('timerStatus').textContent = 
        minutesUntil < 1 ? '‚è±Ô∏è < 1 min!' : `‚è±Ô∏è ${minutesUntil}m`;
    
    nextTaskTimeout = setTimeout(() => {
        triggerNotification(nextTask);
    }, msUntil);
    
    checkInterval = setInterval(() => {
        const currentTime = new Date();
        pendingTasks.forEach(task => {
            const taskTime = new Date(task.date + 'T' + task.time);
            const diff = taskTime - currentTime;
            
            if (diff <= 1000 && diff > -5000 && !task.notified) {
                triggerNotification(task);
            }
        });
        
        if (nextTask && !nextTask.notified) {
            const remaining = nextTask.dateTime - currentTime;
            const mins = Math.floor(remaining / 60000);
            document.getElementById('timerStatus').textContent = 
                mins < 1 ? '‚è±Ô∏è < 1 min!' : `‚è±Ô∏è ${mins}m`;
        }
    }, 1000);
}

function triggerNotification(task) {
    if (task.notified || task.completed) return;
    
    let schedules = getSchedules();
    const taskIndex = schedules.findIndex(t => t.id === task.id);
    if (taskIndex !== -1) {
        schedules[taskIndex].notified = true;
        saveSchedules(schedules);
    }
    
    saveAndRefresh();
    
    playAlertSound();
    
    const title = `üîß ${task.computer} - Maintenance Due!`;
    const body = `${task.type} at ${task.time}`;
    
    if (Notification.permission === 'granted') {
        if (swRegistration) {
            swRegistration.showNotification(title, {
                body: body,
                icon: 'https://cdn-icons-png.flaticon.com/512/3063/3063822.png',
                badge: 'https://cdn-icons-png.flaticon.com/512/3063/3063822.png',
                tag: String(task.id),
                requireInteraction: true,
                vibrate: [200, 100, 200]
            });
        } else {
            new Notification(title, { 
                body, 
                icon: 'https://cdn-icons-png.flaticon.com/512/3063/3063822.png',
                vibrate: [200, 100, 200]
            });
        }
    }
    
    showInAppNotification(task);
    
    setTimeout(scheduleNextCheck, 2000);
}

function showInAppNotification(task) {
    document.getElementById('notifTitle').textContent = `${task.computer} - Maintenance Due!`;
    document.getElementById('notifText').innerHTML = 
        `<strong>${task.type}</strong><br>Time: ${task.time}${task.notes ? '<br><br>üìù ' + task.notes : ''}`;
    document.getElementById('notificationOverlay').style.display = 'flex';
    
    setTimeout(() => {
        if (document.getElementById('notificationOverlay').style.display === 'flex') {
            dismissNotification();
        }
    }, 10000);
}

function dismissNotification() {
    document.getElementById('notificationOverlay').style.display = 'none';
}

function syncWithServiceWorker() {
    const schedules = getSchedules();
    if (navigator.serviceWorker.controller) {
        navigator.serviceWorker.controller.postMessage({
            type: 'SYNC_SCHEDULES',
            schedules: schedules.filter(s => !s.completed && !s.notified)
        });
    }
}

navigator.serviceWorker.addEventListener('message', event => {
    if (event.data?.type === 'TASK_DUE') {
        const schedules = getSchedules();
        const task = schedules.find(t => t.id === event.data.taskId);
        if (task) triggerNotification(task);
    }
});

// Keep alive
document.addEventListener('visibilitychange', () => {
    if (!document.hidden) scheduleNextCheck();
});

setInterval(() => {
    if (!document.hidden && currentUser) scheduleNextCheck();
}, 30000);
</script>
</body>
</html>'''