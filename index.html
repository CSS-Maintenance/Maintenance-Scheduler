<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Computer Maintenance Scheduler</title>
<link rel="manifest" href="/manifest.json">
<style>
body{font-family:Arial;background:#f4f4f9;display:flex;justify-content:center;padding:20px;margin:0;}
.container{background:white;padding:25px;border-radius:12px;box-shadow:0 4px 8px rgba(0,0,0,0.1);width:100%;max-width:420px;}
h2{text-align:center;color:#333;}
label{margin-top:10px;display:block;font-weight:bold;color:#555;}
input,select,textarea,button{width:100%;padding:10px;margin-top:5px;border-radius:6px;border:1px solid #ccc;font-size:15px;box-sizing:border-box;}
button{background:#4CAF50;color:white;border:none;cursor:pointer;margin-top:15px;font-weight:bold;}
button:hover{background:#45a049;}
.cancel{background:#f44336;}
.cancel:hover{background:#da190b;}
.deleteBtn{background:#333;margin-top:8px;color:white;border:none;padding:8px;border-radius:4px;cursor:pointer;width:auto;}
.task-list{margin-top:20px;}
.task-item{background:#e9e9ff;padding:12px;margin-bottom:10px;border-radius:8px;font-size:14px;border-left:4px solid #4CAF50;}
.empty-state{color:#666;text-align:center;padding:20px;font-style:italic;}
.status-box{font-size:13px;padding:10px;border-radius:4px;margin-bottom:15px;text-align:center;font-weight:bold;}
.status-enabled{background:#d4edda;color:#155724;border:1px solid #c3e6cb;}
.status-disabled{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb;}
.status-warning{background:#fff3cd;color:#856404;border:1px solid #ffeaa7;}
.enable-notif-btn{background:#007bff;margin-bottom:10px;}
.enable-notif-btn:hover{background:#0056b3}
.ios-instructions{background:#e7f3ff;padding:15px;border-radius:8px;margin-bottom:15px;font-size:13px;display:none;}
</style>
</head>
<body>
<div class="container">
<h2>üîß Schedule Maintenance</h2>

<div id="notifStatus" class="status-box status-disabled">
üîï Notifications Disabled
</div>

<div id="iosInstructions" class="ios-instructions">
<strong>üì± iPhone/iPad Users:</strong><br>
1. Tap Share button (‚¨ÜÔ∏è)<br>
2. "Add to Home Screen"<br>
3. Open from Home Screen
</div>

<button id="enableNotifBtn" class="enable-notif-btn" onclick="enableNotifications()">
üîî Enable Notifications
</button>

<form id="maintenanceForm">
<label>Computer Unit</label>
<select id="computer" required>
<option value="">Select Computer</option>
<option>PC-01</option>
<option>PC-02</option>
<option>PC-03</option>
<option>PC-04</option>
<option>PC-05</option>
</select>

<label>Date</label>
<input type="date" id="date" required>

<label>Time</label>
<input type="time" id="time" required>

<label>Maintenance Type</label>
<select id="type" required>
<option value="">Select Type</option>
<option>Cleaning</option>
<option>Software Update</option>
<option>Hardware Check</option>
<option>Troubleshooting</option>
</select>

<label>Technician</label>
<input type="text" id="technician" placeholder="Enter name" required>

<label>Notes (Optional)</label>
<textarea id="notes" rows="3" placeholder="Additional details..."></textarea>

<button type="submit">üíæ Save Task</button>
<button type="button" class="cancel" onclick="resetForm()">‚ùå Cancel</button>
</form>

<div class="task-list" id="taskList">
<h3>üìã Upcoming Tasks (<span id="taskCount">0</span>)</h3>
</div>
</div>

<script>
// Detect device type
function isIOS() {
    return /iPad|iPhone|iPod/.test(navigator.userAgent) || 
           (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
}

function isAndroid() {
    return /Android/.test(navigator.userAgent);
}

function isMobile() {
    return isIOS() || isAndroid();
}

function isPWA() {
    return window.matchMedia('(display-mode: standalone)').matches || 
           window.navigator.standalone === true;
}

// Service Worker Registration
let swRegistration = null;

if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js')
        .then(reg => {
            console.log('Service Worker registered:', reg.scope);
            swRegistration = reg;
            updateNotifStatus();
        })
        .catch(err => {
            console.error('SW registration failed:', err);
            document.getElementById('notifStatus').textContent = '‚ö†Ô∏è Error loading service worker';
        });
} else {
    document.getElementById('notifStatus').textContent = '‚ùå Browser too old - no service worker support';
}

// Update UI based on device and permission
function updateNotifStatus() {
    const statusDiv = document.getElementById('notifStatus');
    const btn = document.getElementById('enableNotifBtn');
    const iosDiv = document.getElementById('iosInstructions');
    
    // iOS specific - not installed as PWA
    if (isIOS() && !isPWA()) {
        statusDiv.textContent = 'üì± iOS: Install to Home Screen first';
        statusDiv.className = 'status-box status-warning';
        btn.textContent = 'üì≤ Show Install Instructions';
        iosDiv.style.display = 'block';
        return;
    }
    
    // Android specific
    if (isAndroid()) {
        iosDiv.style.display = 'none';
        if (Notification.permission === 'granted') {
            statusDiv.textContent = 'üîî Android: Notifications Active (works in background!)';
            statusDiv.className = 'status-box status-enabled';
            btn.style.display = 'none';
        } else if (Notification.permission === 'denied') {
            statusDiv.textContent = '‚ùå Notifications blocked - check settings';
            statusDiv.className = 'status-box status-disabled';
            btn.style.display = 'none';
        } else {
            statusDiv.textContent = 'üîï Tap button to enable Android notifications';
            statusDiv.className = 'status-box status-disabled';
        }
        return;
    }
    
    // Desktop
    iosDiv.style.display = 'none';
    if (Notification.permission === 'granted') {
        statusDiv.textContent = 'üîî Desktop: Notifications Active (works when minimized!)';
        statusDiv.className = 'status-box status-enabled';
        btn.style.display = 'none';
    } else if (Notification.permission === 'denied') {
        statusDiv.textContent = '‚ùå Notifications blocked - check browser settings';
        statusDiv.className = 'status-box status-disabled';
        btn.style.display = 'none';
    } else {
        statusDiv.textContent = 'üîï Click button to enable desktop notifications';
        statusDiv.className = 'status-box status-disabled';
    }
}

// Enable notifications button
async function enableNotifications() {
    // iOS not installed
    if (isIOS() && !isPWA()) {
        alert('üì± iOS Installation Required\n\n' +
              'To enable notifications:\n\n' +
              '1. Tap the Share button (‚¨ÜÔ∏è) in Safari\n' +
              '2. Scroll down and tap "Add to Home Screen"\n' +
              '3. Open the app from your Home Screen\n' +
              '4. Then tap this button again\n\n' +
              'Also check: Settings > Safari > Advanced > Experimental Features > Notifications');
        return;
    }
    
    if (!('Notification' in window)) {
        alert('‚ùå This browser does not support notifications.\n\nTry Chrome, Edge, or Firefox.');
        return;
    }
    
    try {
        const permission = await Notification.requestPermission();
        updateNotifStatus();
        
        if (permission === 'granted') {
            // Test notification
            if (swRegistration) {
                await swRegistration.showNotification('‚úÖ Notifications Enabled!', {
                    body: isAndroid() ? 'You will receive alerts even when Chrome is closed!' : 'You will receive alerts even when browser is minimized!',
                    icon: 'https://cdn-icons-png.flaticon.com/512/3063/3063822.png',
                    badge: 'https://cdn-icons-png.flaticon.com/512/3063/3063822.png'
                });
            }
            syncWithServiceWorker();
        } else if (permission === 'denied') {
            alert('‚ùå Notifications blocked.\n\nTo enable:\n' + 
                  (isAndroid() ? 'Chrome ‚ãÆ > Settings > Notifications' : 'Check your browser settings'));
        }
    } catch (err) {
        console.error('Notification error:', err);
        alert('Error: ' + err.message);
    }
}

// Sync data to Service Worker
function syncWithServiceWorker() {
    if (navigator.serviceWorker.controller) {
        navigator.serviceWorker.controller.postMessage({
            type: 'SYNC_SCHEDULES',
            schedules: schedules
        });
    }
}

// App logic
const form = document.getElementById("maintenanceForm");
const taskList = document.getElementById("taskList");
const taskCount = document.getElementById("taskCount");

let schedules = JSON.parse(localStorage.getItem("schedules")) || [];

// Set today's date as minimum
document.getElementById('date').min = new Date().toISOString().split('T')[0];

displayTasks();

form.addEventListener("submit", function(e){
    e.preventDefault();

    let computer = document.getElementById("computer").value;
    let date = document.getElementById("date").value;
    let time = document.getElementById("time").value;
    let type = document.getElementById("type").value;
    let technician = document.getElementById("technician").value;
    let notes = document.getElementById("notes").value;

    // Conflict Check
    for(let s of schedules){
        if(s.computer === computer && s.date === date && s.time === time){
            alert("‚ö†Ô∏è Schedule Conflict!\n\nThis computer already has maintenance at this time.");
            return;
        }
    }

    let newTask = {
        id: Date.now(),
        computer,
        date,
        time,
        type,
        technician,
        notes: notes || "",
        notified: false
    };

    schedules.push(newTask);
    saveAndRefresh();
    form.reset();
    
    // Show success message
    const msg = isMobile() ? 'Task saved! You will be notified.' : 'Task saved successfully!';
    alert('‚úÖ ' + msg);
});

function saveAndRefresh(){
    localStorage.setItem("schedules", JSON.stringify(schedules));
    displayTasks();
    syncWithServiceWorker();
}

function displayTasks(){
    const header = "<h3>üìã Upcoming Tasks (" + schedules.length + ")</h3>";
    
    if(schedules.length === 0){
        taskList.innerHTML = header + '<div class="empty-state">No tasks scheduled.<br>Add your first maintenance task above!</div>';
        taskCount.textContent = "0";
        return;
    }
    
    taskList.innerHTML = header;
    schedules.sort((a,b) => new Date(a.date + "T" + a.time) - new Date(b.date + "T" + b.time));
    
    const now = new Date();
    
    schedules.forEach((task, index) => {
        let div = document.createElement("div");
        div.className = "task-item";
        
        let taskDateTime = new Date(task.date + "T" + task.time);
        let isPast = taskDateTime < now;
        let isSoon = !isPast && (taskDateTime - now < 3600000); // Within 1 hour
        
        let statusBadge = "";
        if (isPast) statusBadge = ' <span style="color:red">[OVERDUE]</span>';
        else if (isSoon) statusBadge = ' <span style="color:orange">[SOON]</span>';
        if (task.notified) statusBadge += ' <span style="color:green">[NOTIFIED]</span>';
        
        div.innerHTML = `
            <strong>${task.computer}</strong>${statusBadge}<br>
            <strong>Type:</strong> ${task.type}<br>
            <strong>When:</strong> ${task.date} at ${task.time}<br>
            <strong>Technician:</strong> ${task.technician}<br>
            ${task.notes ? `<strong>Notes:</strong> ${task.notes}<br>` : ''}
            <button class="deleteBtn" onclick="deleteTask(${index})">üóëÔ∏è Delete</button>
        `;
        taskList.appendChild(div);
    });
    
    taskCount.textContent = schedules.length;
}

function deleteTask(index){
    if(confirm("Delete this maintenance task?")){
        schedules.splice(index, 1);
        saveAndRefresh();
    }
}

function resetForm(){
    form.reset();
}

// Listen for messages from Service Worker
navigator.serviceWorker.addEventListener('message', event => {
    if (event.data && event.data.type === 'TASK_DUE') {
        const task = schedules.find(t => t.id === event.data.taskId);
        if (task) {
            task.notified = true;
            saveAndRefresh();
        }
    }
});

// Periodic sync
setInterval(syncWithServiceWorker, 10000);

// Initial status check
setTimeout(updateNotifStatus, 500);
</script>
</body>
</html>
